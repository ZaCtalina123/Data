#include <Wire.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27, 16, 2); // Адрес 0x27 для 16x2 дисплея

// Константы игры
const int UP_BUTTON = 2;
const int DOWN_BUTTON = 3;
const char PLAYER_CHAR = 'O';
const char CACTUS_CHAR = '#';
const unsigned long FRAME_TIME = 1000 / 60; // 60 FPS (16.66 мс на кадр)

// Переменные игры
int playerPos = 0; // 0 - верхняя строка, 1 - нижняя
int score = 0;
int gameSpeed = 30; // Чем меньше, тем быстрее (кадры между кактусами)
int cactusLength = 1;
bool gameOver = false;

// Массив для хранения кактусов (0-15 позиции, 0-1 строки)
bool cacti[2][16] = {false};

void setup() {
  // Инициализация кнопок с внутренними подтягивающими резисторами
  pinMode(UP_BUTTON, INPUT_PULLUP);
  pinMode(DOWN_BUTTON, INPUT_PULLUP);
  
  // Инициализация дисплея
  lcd.init();
  lcd.backlight();
  
  // Случайное зерно для рандома
  randomSeed(analogRead(0));
  
  // Начальное сообщение
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Cactus Dodger!");
  lcd.setCursor(0, 1);
  lcd.print("Press any button");
  
  // Ждем нажатия любой кнопки для старта
  while (digitalRead(UP_BUTTON) && digitalRead(DOWN_BUTTON)) {
    delay(10);
  }
  
  lcd.clear();
}

void loop() {
  if (gameOver) {
    // Экран окончания игры
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Game Over!");
    lcd.setCursor(0, 1);
    lcd.print("Score: ");
    lcd.print(score);
    
    // Ждем нажатия любой кнопки для рестарта
    while (digitalRead(UP_BUTTON) && digitalRead(DOWN_BUTTON)) {
      delay(10);
    }
    
    // Сброс игры
    resetGame();
    return;
  }
  
  static unsigned long lastFrameTime = 0;
  static int framesSinceLastCactus = 0;
  
  // Ограничение FPS
  unsigned long currentTime = millis();
  if (currentTime - lastFrameTime < FRAME_TIME) {
    delay(1);
    return;
  }
  lastFrameTime = currentTime;
  
  // Обработка ввода
  handleInput();
  
  // Генерация кактусов
  if (++framesSinceLastCactus >= gameSpeed) {
    generateCactus();
    framesSinceLastCactus = 0;
  }
  
  // Движение кактусов
  moveCacti();
  
  // Проверка столкновений
  checkCollisions();
  
  // Отрисовка
  drawGame();
}

void handleInput() {
  // Кнопка вверх (перемещение на верхнюю строку)
  if (!digitalRead(UP_BUTTON)) {
    playerPos = 0;
    delay(50); // Простой дебаунс
  }
  
  // Кнопка вниз (перемещение на нижнюю строку)
  if (!digitalRead(DOWN_BUTTON)) {
    playerPos = 1;
    delay(50); // Простой дебаунс
  }
}

void generateCactus() {
  // Случайно решаем, генерировать ли кактус (50% шанс)
  if (random(2) == 0) return;
  
  // Выбираем случайную длину кактуса (1-3)
  cactusLength = random(1, 4);
  
  // Выбираем случайную строку (0 или 1)
  int row = random(2);
  
  // Убедимся, что есть место для кактуса
  bool spaceAvailable = true;
  for (int i = 15; i > 15 - cactusLength; i--) {
    if (i < 0 || cacti[row][i]) {
      spaceAvailable = false;
      break;
    }
  }
  
  // Если место есть, создаем кактус
  if (spaceAvailable) {
    for (int i = 15; i > 15 - cactusLength; i--) {
      if (i >= 0) {
        cacti[row][i] = true;
      }
    }
  }
  
  // Увеличиваем сложность
  if (score % 5 == 0 && gameSpeed > 10) {
    gameSpeed--;
  }
}

void moveCacti() {
  // Перемещаем все кактусы на один шаг влево
  for (int row = 0; row < 2; row++) {
    for (int col = 0; col < 15; col++) {
      cacti[row][col] = cacti[row][col+1];
    }
    cacti[row][15] = false;
  }
}

void checkCollisions() {
  // Проверяем столкновение игрока с кактусом в его строке
  if (cacti[playerPos][0]) {
    gameOver = true;
  }
  
  // Увеличиваем счет, если кактус прошел мимо
  for (int row = 0; row < 2; row++) {
    if (cacti[row][0] && row != playerPos) {
      score++;
    }
  }
}

void drawGame() {
  lcd.clear();
  
  // Рисуем игрока
  lcd.setCursor(2, playerPos);
  lcd.print(PLAYER_CHAR);
  
  // Рисуем кактусы
  for (int row = 0; row < 2; row++) {
    for (int col = 0; col < 16; col++) {
      if (cacti[row][col]) {
        lcd.setCursor(col, row);
        lcd.print(CACTUS_CHAR);
      }
    }
  }
  
  // Рисуем счет
  lcd.setCursor(12, 0);
  lcd.print(score);
}

void resetGame() {
  // Сброс всех переменных игры
  playerPos = 0;
  score = 0;
  gameSpeed = 30;
  gameOver = false;
  
  // Очистка массива кактусов
  for (int row = 0; row < 2; row++) {
    for (int col = 0; col < 16; col++) {
      cacti[row][col] = false;
    }
  }
  
  lcd.clear();
}
